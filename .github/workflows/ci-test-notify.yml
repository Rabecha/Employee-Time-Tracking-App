name: CI Test Pipeline with Notifications

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: time_tracking_app
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      id: test
      run: npm test 2>&1 | tee test-output.txt
      env:
        DB_HOST: localhost
        DB_USER: root
        DB_PASSWORD: password
        DB_NAME: time_tracking_app
      continue-on-error: true

    - name: Capture test results
      id: capture
      if: always()
      run: |
        STATUS="${{ job.status }}"
        echo "test_status=$STATUS" >> $GITHUB_OUTPUT
        SUMMARY=$(head -n 50 test-output.txt || echo "No test output")
        echo "test_summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Send test results to Slack
      if: always() && secrets.SLACK_SECRET != ''
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_SECRET }}
      run: |
        EMOJI="✅"
        STATUS="${{ job.status }}"
        if [ "$STATUS" != "success" ]; then EMOJI="❌"; fi
        
        PAYLOAD=$(cat <<'PAYLOAD_END'
        {
          "text": "${{ job.status }} - Tests in ${{ github.repository }}",
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "$EMOJI *Tests $STATUS*\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Results>"
              }
            }
          ]
        }
        PAYLOAD_END
        )
        
        curl -s -X POST \
          -H 'Content-type: application/json' \
          --data "$PAYLOAD" \
          "$SLACK_WEBHOOK"

    - name: Send email notification (fallback)
      if: always() && secrets.SLACK_SECRET == '' && secrets.SMTP_HOST != ''
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_HOST }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "[CI] Tests ${{ job.status }} - ${{ github.repository }}"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_FROM }}
        body: |
          Tests status: ${{ job.status }}
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Fail if tests failed
      if: steps.test.outcome == 'failure'
      run: exit 1

  build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: docker build -t notes-app:${{ github.sha }} .
    
    - name: Test Docker image
      run: |
        docker run -d --name test-container -p 3000:3000 notes-app:${{ github.sha }}
        sleep 10
        curl -f http://localhost:3000/health || exit 1
        docker stop test-container
